{"version":3,"sources":["utils/positioner/Popper.tsx"],"names":["useDeepMemo","memoFn","key","ref","React","useRef","current","value","createPopper","reference","popper","options","instance","_PopperJS","default","eventsEnabled","originalUpdate","update","style","left","top","actualWindow","ownerDocument","defaultView","scheduleUpdate","requestAnimationFrame","enableEventListeners","Popper","props","align","children","enabled","flipBoundary","userModifiers","modifiers","offset","overflowBoundary","pointerTargetRef","position","positionFixed","positioningDependencies","rtl","targetRef","unstable_pinned","proposedPlacement","popperRef","contentRef","latestPlacement","useState","computedPlacement","setComputedPlacement","hasDocument","hasScrollableElement","useMemo","scrollParentElement","body","computedModifiers","computeStyle","gpuAcceleration","flip","padding","flipVariationsByContent","preventOverflow","keepTogether","escapeWithReference","boundariesElement","useCallback","destroyInstance","destroy","createInstance","hasPointer","handleUpdate","data","placement","arrow","element","onCreate","onUpdate","useEffect","child","Children","only","defaultProps"],"mappings":"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","sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-bindings';\nimport { Ref, isRefObject } from '@fluentui/react-component-ref';\nimport * as _ from 'lodash';\nimport PopperJS, * as _PopperJS from 'popper.js';\nimport * as React from 'react';\n\nimport isBrowser from '../isBrowser';\nimport getScrollParent from './getScrollParent';\nimport { getPlacement, applyRtlToOffset } from './positioningHelper';\nimport { PopperProps } from './types';\n\n/**\n * Memoize a result using deep equality. This hook has two advantages over\n * React.useMemo: it uses deep equality to compare memo keys, and it guarantees\n * that the memo function will only be called if the keys are unequal.\n * React.useMemo cannot be relied on to do this, since it is only a performance\n * optimization (see https://reactjs.org/docs/hooks-reference.html#usememo).\n *\n * Copied from https://github.com/apollographql/react-apollo/blob/master/packages/hooks/src/utils/useDeepMemo.ts.\n */\nfunction useDeepMemo<TKey, TValue>(memoFn: () => TValue, key: TKey): TValue {\n  const ref = React.useRef<{ key: TKey; value: TValue }>();\n\n  if (!ref.current || !_.isEqual(key, ref.current.key)) {\n    ref.current = { key, value: memoFn() };\n  }\n\n  return ref.current.value;\n}\n\n// `popper.js` has a UMD build without `.default`, it breaks CJS builds:\n// https://github.com/rollup/rollup/issues/1267#issuecomment-446681320\nconst createPopper = (\n  reference: Element | _PopperJS.ReferenceObject,\n  popper: HTMLElement,\n  options?: PopperJS.PopperOptions,\n): PopperJS => {\n  const instance = new ((_PopperJS as any).default || _PopperJS)(reference, popper, {\n    ...options,\n    eventsEnabled: false,\n  });\n\n  const originalUpdate = instance.update;\n  instance.update = () => {\n    // Fix Popper.js initial positioning display issue\n    // https://github.com/popperjs/popper.js/issues/457#issuecomment-367692177\n    popper.style.left = '0';\n    popper.style.top = '0';\n\n    originalUpdate();\n  };\n\n  const actualWindow = popper.ownerDocument.defaultView;\n  instance.scheduleUpdate = () => actualWindow.requestAnimationFrame(instance.update);\n  instance.enableEventListeners();\n\n  return instance;\n};\n\n/**\n * Popper relies on the 3rd party library [Popper.js](https://github.com/FezVrasta/popper.js) for positioning.\n */\nconst Popper: React.FunctionComponent<PopperProps> = props => {\n  const {\n    align,\n    children,\n    enabled,\n    flipBoundary,\n    modifiers: userModifiers,\n    offset,\n    overflowBoundary,\n    pointerTargetRef,\n    position,\n    positionFixed,\n    positioningDependencies = [],\n    rtl,\n    targetRef,\n    unstable_pinned,\n  } = props;\n\n  const proposedPlacement = getPlacement({ align, position, rtl });\n\n  const popperRef = React.useRef<PopperJS>();\n  const contentRef = React.useRef<HTMLElement>(null);\n\n  const latestPlacement = React.useRef<PopperJS.Placement>(proposedPlacement);\n  const [computedPlacement, setComputedPlacement] = React.useState<PopperJS.Placement>(proposedPlacement);\n\n  const hasDocument = isBrowser();\n  const hasScrollableElement = React.useMemo(() => {\n    if (hasDocument) {\n      const scrollParentElement = getScrollParent(contentRef.current);\n\n      return scrollParentElement !== scrollParentElement.ownerDocument.body;\n    }\n\n    return false;\n  }, [contentRef, hasDocument]);\n  // Is a broken dependency and can cause potential bugs, we should rethink this as all other refs\n  // in this component.\n\n  const computedModifiers: PopperJS.Modifiers = useDeepMemo(\n    () =>\n      _.merge(\n        /**\n         * This prevents blurrines in chrome, when the coordinates are odd numbers alternative\n         * would be to use `fn` and manipulate the computed style or ask popper to fix it but\n         * since there is presumably only handful of poppers displayed on the page, the\n         * performance impact should be minimal.\n         */\n        { computeStyle: { gpuAcceleration: false } },\n\n        { flip: { padding: 0, flipVariationsByContent: true } },\n        { preventOverflow: { padding: 0 } },\n\n        offset && {\n          offset: { offset: rtl ? applyRtlToOffset(offset, position) : offset },\n          keepTogether: { enabled: false },\n        },\n\n        /**\n         * When the popper box is placed in the context of a scrollable element, we need to set\n         * preventOverflow.escapeWithReference to true and flip.boundariesElement to 'scrollParent'\n         * (default is 'viewport') so that the popper box will stick with the targetRef when we\n         * scroll targetRef out of the viewport.\n         */\n        hasScrollableElement && {\n          preventOverflow: { escapeWithReference: true },\n          flip: { boundariesElement: 'scrollParent' },\n        },\n\n        flipBoundary && { flip: { boundariesElement: flipBoundary } },\n        overflowBoundary && { preventOverflow: { boundariesElement: overflowBoundary } },\n\n        userModifiers,\n\n        /**\n         * unstable_pinned disables the flip modifier by setting flip.enabled to false; this\n         * disables automatic repositioning of the popper box; it will always be placed according to\n         * the values of `align` and `position` props, regardless of the size of the component, the\n         * reference element or the viewport.\n         */\n        unstable_pinned && { flip: { enabled: false } },\n      ),\n    [hasScrollableElement, position, offset, rtl, unstable_pinned, userModifiers],\n  );\n\n  const scheduleUpdate = React.useCallback(() => {\n    if (popperRef.current) {\n      popperRef.current.scheduleUpdate();\n    }\n  }, []);\n\n  const destroyInstance = React.useCallback(() => {\n    if (popperRef.current) {\n      popperRef.current.destroy();\n      if (popperRef.current.popper) {\n        // Popper keeps a reference to the DOM node, which needs to be cleaned up\n        // temporarily fix it here until fixed properly in popper\n        popperRef.current.popper = null;\n      }\n      popperRef.current = null;\n    }\n  }, []);\n\n  const createInstance = React.useCallback(() => {\n    destroyInstance();\n\n    const reference =\n      targetRef && isRefObject(targetRef)\n        ? (targetRef as React.RefObject<Element>).current\n        : (targetRef as _PopperJS.ReferenceObject);\n\n    if (!enabled || !reference || !contentRef.current) {\n      return;\n    }\n\n    const hasPointer = !!(pointerTargetRef && pointerTargetRef.current);\n    const handleUpdate = (data: PopperJS.Data) => {\n      // PopperJS performs computations that might update the computed placement: auto positioning, flipping the\n      // placement in case the popper box should be rendered at the edge of the viewport and does not fit\n      if (data.placement !== latestPlacement.current) {\n        latestPlacement.current = data.placement;\n        setComputedPlacement(data.placement);\n      }\n    };\n\n    const options: PopperJS.PopperOptions = {\n      placement: proposedPlacement,\n      positionFixed,\n      modifiers: {\n        ...computedModifiers,\n\n        /**\n         * This modifier is necessary in order to render the pointer. Refs are resolved in effects, so it can't be\n         * placed under computed modifiers. Deep merge is not required as this modifier has only these properties.\n         * `arrow` modifier also requires `keepTogether`.\n         */\n        keepTogether: { enabled: hasPointer },\n        arrow: {\n          enabled: hasPointer,\n          element: pointerTargetRef && pointerTargetRef.current,\n        },\n      },\n      onCreate: handleUpdate,\n      onUpdate: handleUpdate,\n    };\n\n    popperRef.current = createPopper(reference, contentRef.current, options);\n  }, [\n    // TODO review dependencies for popperHasScrollableParent\n    enabled,\n    computedModifiers,\n    pointerTargetRef,\n    positionFixed,\n    proposedPlacement,\n    targetRef,\n    unstable_pinned,\n  ]);\n\n  useIsomorphicLayoutEffect(() => {\n    createInstance();\n    return destroyInstance;\n  }, [createInstance]);\n\n  React.useEffect(scheduleUpdate, [...positioningDependencies, computedPlacement]);\n\n  const child =\n    typeof children === 'function'\n      ? children({ placement: computedPlacement, scheduleUpdate })\n      : (children as React.ReactElement);\n\n  return child ? <Ref innerRef={contentRef}>{React.Children.only(child)}</Ref> : null;\n};\n\nPopper.defaultProps = {\n  enabled: true,\n  positionFixed: false,\n  positioningDependencies: [],\n};\n\nexport default Popper;\n"],"file":"Popper.js"}